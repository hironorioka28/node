<% include ../partials/header %>
<div class="question">
  <section class="question__wrapper question__wrapper--q" style="background-image:url(/img/qbg/qXbg.jpg)">
    <div class="container container--q">
      <h1 class="container__title">BREAK</h1>
      <p class="container__question">トイレットペーパー速巻き対決！！</p>
    </div>
  </section>
  <section id="js-preQuestion" class="question__wrapper question__wrapper--q" style="background-image:url(/img/qbg/qXbg.jpg)">
    <div class="container container--q">
      <h1 class="container__title">問題</h1>
      <p class="container__question">1位になるのは次の4組のうち、どこでしょう？</p>
    </div>
  </section>
  <section id="js-selection" class="question__wrapper">
    <div class="container">
      <p class="container__question container__question--forSelection">1位になるのは次の4組のうち、どこでしょう？</p>
      <div class="container__table">
        <table class="selectionTable">
          <tbody class="selectionTable__tbody">
            <tr class="selectionTable__row">
              <td class="selectionTable__data" style="background-image:url(/img/selections/X/A.jpg)"></td>
              <td class="selectionTable__data" style="background-image:url(/img/selections/X/B.jpg)"></td>
            </tr>
            <tr class="selectionTable__row">
              <td class="selectionTable__data" style="background-image:url(/img/selections/X/C.jpg)"></td>
              <td class="selectionTable__data" style="background-image:url(/img/selections/X/D.jpg)"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
  <section id="js-answer" class="question__wrapper">
    <div class="container">
      <p class="container__XAnswer"><span id="XWinner" class="container__XWinner"></span>の勝利！</p>
    </div>
  </section>
  <section id="js-ranking" class="question__wrapper">
    <div class="container">
      <div class="container__rankingList">
        <ol id="js-rankingList" class="rankingList"></ol>
      </div>
    </div>
  </section>
</div><!-- /.question -->
<% include ../partials/scripts %>
<script>
  $(function() {
    var socket = io.connect();

    // 問題文の表示
    socket.on("qXPreQuestion", function(data) {
      var speed = 400,
          position = $("#js-preQuestion").offset().top;

      $("body").animate({scrollTop: position}, speed, "swing");
    });

    // 選択肢の表示・回答スタート
    socket.on("qXSelection", function(data) {
      var speed = 400,
          position = $("#js-selection").offset().top;

      $("body").animate({scrollTop: position}, speed, "swing");
    });

    // 正解VTR
    socket.on("qXAnswer", function(data) {
      var speed = 400,
          position = $("#js-answer").offset().top;

      if ($(".js-showAnswer").length) {
        $(".js-showAnswer").remove();
      };

      $("body").animate({scrollTop: position}, speed, "swing");

      $("#XWinner").text(data);
      // answer.ejsへ正解情報をおくる
      socket.emit("qXFinalAnswer", data);
    });

    // ランキングデータをセット
    socket.on("rankingData_from_server", function(data) {
      $("#js-rankingList").append('<li class="rankingList__item"><div class="rankingList__innerWrapper" data-ranktime="' + data.time + '"><p class="rankingList__name">' + data.name + '</p><p class="rankingList__time">' + (data.time / 1000) + ' sec</p></div></li>');
    });

    socket.on("qXRanking", function(data) {
      var $rankingLiTmp = $("#js-rankingList").find("li"),
          speed = 400,
          position = $("#js-ranking").offset().top,
          sortList = [],
          i = 0;

      $rankingLiTmp.find("p").hide();

      $("body").animate({scrollTop: position}, speed, "swing");

      $rankingLiTmp.each(function() {
        sortList.push($(this).html());
      });

      sortList.sort(function(a, b) {
        return parseInt($(a).data("ranktime")) < parseInt($(b).data("ranktime")) ? -1 : 1;
      });

      $rankingLiTmp.empty();

      $rankingLiTmp.each(function() {
        if (i < 10) {
          $(this).append(sortList[i]);
          i++;
        } else {
          $(this).remove();
        }
      });

      var $rankingLi = $("#js-rankingList").find("li");


      $($rankingLi.get().reverse()).each(function(index) {
          $(this).find("p").delay(2000 * index).fadeIn();
      });
    });
  });
</script>
<% include ../partials/footer %>
